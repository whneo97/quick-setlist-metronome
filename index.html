<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Quick Setlist Metronome (Mobile)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Roboto:wght@900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700;900&display=swap');
    :root{
      --bg: #0b0b0f;
      --fg: #e8e8ee;
      --muted: #9aa0aa;
      --accent: #14b8a6;
      --accent-2: #8b5cf6;
      --danger: #ef4444;
      --btn-height: 18dvh;
      --radius: 18px;
      --disabled-bg: #2a2f36;
      --disabled-color: #6b7280;
      --preset-title-height: 4dvh;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:'Roboto','Roboto Mono',ui-sans-serif,system-ui,-apple-system,Segoe UI,Arial;font-weight:900;letter-spacing:0.02em;}
    .app{height:100dvh;display:flex;flex-direction:column;}
    .page{display:none;height:100%}
    .page.active{display:flex;flex-direction:column;min-height:100%}
    .bottom{position:sticky;bottom:0;height:var(--btn-height);width:100%}
    .bottom button{height:100%;width:100%;border:0;margin:0;font-size:clamp(20px,5vw,38px);font-weight:900;transition: 0.2s ease,color 0.2s ease;font-family:'Oswald',sans-serif;}
    #goBtn{background:var(--accent);color:#081012;}
    #goBtn:disabled{background:var(--disabled-bg);color:var(--disabled-color);cursor:not-allowed;}
    .back-btn{background:#1f2430;color:var(--fg);}
    .p1-main{flex:1;display:flex;align-items:center;justify-content:center;padding:2.5vh 4vw;}
    .form{width:100%;max-width:900px;display:flex;flex-direction:column;gap:2.2vh;}
    .label{text-align:center;font-size:clamp(16px,3.8vw,22px);color:var(--muted);}
    .textbox{width:100%;min-height:24dvh;background:#12141a;color:var(--fg);border:2px solid #1f2430;border-radius:var(--radius);padding:2.2vh;font-size:clamp(24px,6.8vw,44px);overflow-y:auto;scrollbar-color:#555 #12141a;scrollbar-width:thin}
    .textbox::-webkit-scrollbar{width:8px;}
    .textbox::-webkit-scrollbar-track{background:#12141a;}
    .textbox::-webkit-scrollbar-thumb{background:#555;border-radius:4px;}
    .error-msg{display:none;text-align:center;color:var(--danger);font-size:clamp(12px,3.2vw,16px);}    
    .preset-list{max-height:30vh;overflow-y:auto;background:#11151c;border-radius:var(--radius);padding:1vh;display:none;flex-direction:column;gap:1vh;scrollbar-color:#555 #11151c;scrollbar-width:thin;}
    .preset-list::-webkit-scrollbar{width:8px;}
    .preset-list::-webkit-scrollbar-track{background:#11151c;}
    .preset-list::-webkit-scrollbar-thumb{background:#555;border-radius:4px;}
    .preset-item{display:flex;align-items:center;justify-content:space-between;gap:1.2rem;background:#181c24;padding:1vh;border-radius:var(--radius);}
    .preset-info{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .preset-item.invalid .preset-info{color:var(--danger);}
    .preset-actions{display:flex;gap:clamp(1rem,6vw,3.5rem);flex-shrink:0;}
    .preset-item button{background:none;border:none;color:var(--accent);font-size:clamp(14px,3.5vw,20px);font-family:'Roboto','Roboto Mono',sans-serif;}    
    .preset-item.invalid button.load-btn{color:#555;pointer-events:none;}
    .tempo-container{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .preset-titles{height:var(--preset-title-height);display:flex;align-items:center;justify-content:center;font-size:clamp(14px,3.5vw,20px);color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .tempo-scroll{flex:1;overflow-y:auto;scrollbar-color:#555 #141821;scrollbar-width:thin;}
    .tempo-scroll::-webkit-scrollbar{width:8px;}
    .tempo-scroll::-webkit-scrollbar-track{background:#141821;}
    .tempo-scroll::-webkit-scrollbar-thumb{background:#555;border-radius:4px;}
    .tempo-list{display:flex;flex-direction:column;min-height:100%;}
    .tempo-btn{flex:1;width:100%;display:flex;align-items:center;justify-content:center;background:#141821;color:var(--fg);font-size:clamp(28px,8vw,60px);font-weight:900;position:relative;overflow:hidden;border:none;font-family:'Oswald',sans-serif;}
    .tempo-btn:nth-child(odd){background:#10141c;}
    .flash-layer{position:absolute;inset:0;background:radial-gradient(circle,rgba(255,255,255,0.22),transparent 55%);opacity:0;pointer-events:none;transition:opacity 120ms ease-out;}
    .flash-layer.show{opacity:1;}
    .live-dot{position:absolute;top:10px;right:12px;width:14px;height:14px;border-radius:999px;background:#374151;}
    .tempo-btn.active .live-dot{background:var(--accent-2);}    
    #fullscreenBtn {
      color: var(--accent);
      transition: color 0.18s;
    }
    #fullscreenBtn:focus, #fullscreenBtn:hover {
      color: var(--accent-2);
      outline: none;
    }
    .version-badge {
      position: fixed;
      top: 0.7em;
      left: 1em;
      z-index: 1001;
      background: rgba(20,24,33,0.85);
      color: var(--muted);
      font-size: 1.1em;
      font-family: 'Roboto Mono', monospace;
      font-weight: 700;
      padding: 0.18em 0.7em;
      border-radius: 1em;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <section class="page active" id="page1">
    <div class="version-badge">v1.0</div>
    <main class="p1-main">
      <div class="form">
        <div class="label">Enter BPM values or choose a preset</div>
        <button id="fullscreenBtn" type="button" aria-label="Toggle Fullscreen" style="position:absolute;top:1.2vh;right:2vw;background:none;border:none;padding:0.5em;z-index:10;cursor:pointer;color:var(--accent);">
          <svg id="fullscreenIcon" width="2.2em" height="2.2em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:block;pointer-events:none;">
            <polyline id="fsEnter1" points="4 8 4 4 8 4"/><line id="fsEnter2" x1="4" y1="4" x2="10" y2="10"/>
            <polyline id="fsEnter3" points="20 16 20 20 16 20"/><line id="fsEnter4" x1="20" y1="20" x2="14" y2="14"/>
          </svg>
        </button>
        <textarea id="bpmInput" class="textbox" placeholder="e.g. 60,120,90"></textarea>
        <div id="errorMsg" class="error-msg" role="alert" aria-live="polite"></div>
        <div class="preset-list" id="presetList"></div>
      </div>
    </main>
    <div class="bottom">
      <button id="goBtn" disabled>GO</button>
    </div>
  </section>

  <section class="page" id="page2">
    <div class="tempo-container">
      <div id="presetTitles" class="preset-titles" style="display:none;"></div>
      <div class="tempo-scroll">
        <main class="tempo-list" id="tempoList"></main>
      </div>
    </div>
    <div class="bottom"><button id="backBtn" class="back-btn">BACK</button></div>
  </section>
</div>
<div id="modalOverlay" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.45);align-items:flex-start;justify-content:center;overflow:auto;padding-top:8vh;">
  <div id="modalBox" style="background:#181c24;color:#e8e8ee;padding:2em 1.5em;border-radius:18px;max-width:90vw;box-shadow:0 4px 32px #000a;min-width:240px;margin-top:8vh;">
    <div id="modalMsg" style="margin-bottom:1.2em;"></div>
    <input id="modalInput" style="width:100%;font-size:1.1em;padding:0.5em;margin-bottom:1em;display:none;background:#12141a;color:#e8e8ee;border:1.5px solid #333;border-radius:8px;" />
    <div style="display:flex;gap:1em;justify-content:flex-end;">
      <button id="modalCancel" style="background:none;border:none;color:#ef4444;font-size:1em;">Cancel</button>
      <button id="modalOk" style="background:var(--accent);border:none;color:#081012;font-size:1em;padding:0.4em 1.2em;border-radius:8px;">OK</button>
    </div>
  </div>
</div>
<script>
(function(){
  const bpmInput=document.querySelector('#bpmInput');
  const goBtn=document.querySelector('#goBtn');
  const backBtn=document.querySelector('#backBtn');
  const tempoList=document.querySelector('#tempoList');
  const presetList=document.querySelector('#presetList');
  const errorMsg=document.querySelector('#errorMsg');
  const presetTitles=document.querySelector('#presetTitles');

  let presets=JSON.parse(localStorage.getItem('bpmPresets')||'[]');

  function savePresets(){localStorage.setItem('bpmPresets',JSON.stringify(presets));renderPresets();}
  function renderPresets(){
    presetList.innerHTML='';
    if(presets.length===0){presetList.style.display='none';return;}
    presetList.style.display='flex';
    presets.forEach((p,i)=>{
      const {ok}=parseBPMs(p.value);
      const div=document.createElement('div');div.className='preset-item'+(ok?'':' invalid');
      const info=document.createElement('div');info.className='preset-info';info.textContent=`${p.name}: ${p.value}`;
      const actions=document.createElement('div');actions.className='preset-actions';
      const loadBtn=document.createElement('button');loadBtn.textContent='Load';loadBtn.className='load-btn';loadBtn.onclick=()=>{bpmInput.value=p.value;updateValidation();};
      const editBtn=document.createElement('button');editBtn.textContent='Edit';editBtn.onclick=async()=>{
        const nv = await showModal({message:'Edit BPM list',input:true,defaultValue:p.value});
        if(nv!==false){
          p.value = nv;
          const newName = await showModal({message:'Preset name',input:true,defaultValue:p.name});
          if(newName!==false) p.name = newName;
          savePresets();
        }
      };
      const delBtn=document.createElement('button');delBtn.textContent='Del';delBtn.onclick=async()=>{
        const confirm = await showModal({message:'Delete this preset?',input:false,okText:'Delete',cancelText:'Cancel'});
        if(confirm) { presets.splice(i,1); savePresets(); }
      };
      if(!ok)loadBtn.disabled=true;
      actions.append(loadBtn,editBtn,delBtn);
      div.append(info,actions);
      presetList.appendChild(div);
    });
  }

  function parseBPMs(txt){
    const raw=txt.split(',').map(s=>s.trim()).filter(Boolean);
    if(!raw.length)return{ok:false,list:[],message:''};
    const nums=[];
    for(const r of raw){
      if(!/^\d+(?:\.\d+)?$/.test(r))return{ok:false,list:[],message:`Invalid number: "${r}"`};
      const v=parseFloat(r);
      if(!(v>0))return{ok:false,list:[],message:`BPM must be > 0: "${r}"`};
      nums.push(v);
    }
    return{ok:true,list:nums,message:''};
  }

  function inputsEqual(a,b){
    const normA=a.split(',').map(s=>s.trim()).filter(Boolean);
    const normB=b.split(',').map(s=>s.trim()).filter(Boolean);
    if(normA.length!==normB.length)return false;
    return normA.every((v,i)=>v===normB[i]);
  }

  function updateValidation(){
    const {ok,message}=parseBPMs(bpmInput.value);
    goBtn.disabled=!ok;
    if(ok||bpmInput.value.trim()===''){errorMsg.textContent='';errorMsg.style.display='none';}
    else{errorMsg.textContent=message;errorMsg.style.display='block';}
  }
  bpmInput.addEventListener('input',updateValidation);
  updateValidation();
  renderPresets();

  goBtn.onclick=async()=>{
    const {ok,list}=parseBPMs(bpmInput.value);
    if(!ok){updateValidation();return;}
    const duplicateExists=presets.some(p=>inputsEqual(p.value,bpmInput.value));
    let name=null;
    if(!duplicateExists){
      name=await showModal({message:'Preset name?',input:true,defaultValue:'My preset'});
      if(name){
        presets.push({name,value:bpmInput.value});
        savePresets();
      }
    }
    const matchingTitles=presets.filter(p=>inputsEqual(p.value,bpmInput.value)).map(p=>p.name);
    if(matchingTitles.length>0){
      presetTitles.textContent=matchingTitles.join(', ');
      presetTitles.style.display='flex';
    } else {
      presetTitles.style.display='none';
    }
    buildTempoButtons(list);
    showPage(2);
  };
  backBtn.onclick=()=>{stopAllFlashes();tempoList.innerHTML='';presetTitles.style.display='none';showPage(1);};

  function showPage(n){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelector(n===1?'#page1':'#page2').classList.add('active');}
  const timers=new Map();
  function stopFlash(b){
    const obj=timers.get(b);
    if(obj&&obj.cancel){obj.cancel();timers.delete(b);}
    b.classList.remove('active');
  }
  function stopAllFlashes(){timers.forEach(obj=>obj.cancel&&obj.cancel());timers.clear();document.querySelectorAll('.tempo-btn').forEach(b=>b.classList.remove('active'))}
  function startFlash(b,bpm){
    stopFlash(b);
    const ms=60000/bpm;
    const f=b.querySelector('.flash-layer');
    let running=true;
    let next=performance.now();
    function loop(){
      if(!running) return;
      const now=performance.now();
      if(now>=next){
        f.classList.add('show');
        setTimeout(()=>f.classList.remove('show'),120);
        next+=ms;
        // In case of drift, catch up
        if(now-next>ms) next=now+ms;
      }
      if(running) requestAnimationFrame(loop);
    }
    timers.set(b,{cancel:()=>{running=false;}});
    b.classList.add('active');
    f.classList.add('show');
    setTimeout(()=>f.classList.remove('show'),140);
    requestAnimationFrame(loop);
  }
  function toggleFlash(b){timers.has(b)?stopFlash(b):startFlash(b,parseFloat(b.dataset.bpm));}
  function buildTempoButtons(list){
    tempoList.innerHTML='';
    list.forEach(bpm=>{
      const b=document.createElement('button');
      b.className='tempo-btn';
      b.dataset.bpm=bpm;
      b.innerHTML=`<div class="flash-layer"></div><div class="live-dot"></div><div>${bpm} BPM</div>`;
      b.onclick=()=>toggleFlash(b);
      tempoList.appendChild(b);
    });
  }

  if('wakeLock' in navigator){navigator.wakeLock.request('screen').catch(()=>{});}  
  const fullscreenBtn=document.getElementById('fullscreenBtn');
  const fullscreenIcon=document.getElementById('fullscreenIcon');
  function isFullscreen(){
    return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  }
  function updateFullscreenBtn(){
    if(isFullscreen()){
      // Change icon to 'exit' (arrows inward)
      fullscreenIcon.innerHTML='<polyline points="9 9 4 4 4 9"/><line x1="4" y1="4" x2="10" y2="10"/><polyline points="15 15 20 20 20 15"/><line x1="20" y1="20" x2="14" y2="14"/>';
    }else{
      // Change icon to 'enter' (arrows outward)
      fullscreenIcon.innerHTML='<polyline points="4 8 4 4 8 4"/><line x1="4" y1="4" x2="10" y2="10"/><polyline points="20 16 20 20 16 20"/><line x1="20" y1="20" x2="14" y2="14"/>';
    }
  }
  if(fullscreenBtn){
    fullscreenBtn.onclick=function(){
      const el=document.documentElement;
      if(isFullscreen()){
        if(document.exitFullscreen){document.exitFullscreen();}
        else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}
        else if(document.msExitFullscreen){document.msExitFullscreen();}
      }else{
        if(el.requestFullscreen){el.requestFullscreen();}
        else if(el.webkitRequestFullscreen){el.webkitRequestFullscreen();}
        else if(el.msRequestFullscreen){el.msRequestFullscreen();}
      }
    };
    document.addEventListener('fullscreenchange',updateFullscreenBtn);
    document.addEventListener('webkitfullscreenchange',updateFullscreenBtn);
    document.addEventListener('msfullscreenchange',updateFullscreenBtn);
    updateFullscreenBtn();
  }

  // --- Modal logic ---
  function showModal({message,input=false,defaultValue='',okText='OK',cancelText='Cancel'}) {
    return new Promise(resolve=>{
      const overlay = document.getElementById('modalOverlay');
      const msg = document.getElementById('modalMsg');
      const inp = document.getElementById('modalInput');
      const ok = document.getElementById('modalOk');
      const cancel = document.getElementById('modalCancel');
      msg.textContent = message;
      inp.style.display = input ? '' : 'none';
      inp.value = defaultValue;
      ok.textContent = okText;
      cancel.textContent = cancelText;
      overlay.style.display = 'flex';
      if(input) inp.focus();
      function cleanup(val) {
        overlay.style.display = 'none';
        ok.onclick = cancel.onclick = overlay.onkeydown = null;
        resolve(val);
      }
      ok.onclick = ()=>cleanup(input ? inp.value : true);
      cancel.onclick = ()=>cleanup(false);
      overlay.onkeydown = e=>{
        if(e.key==='Escape') cleanup(false);
        if(e.key==='Enter' && input) cleanup(inp.value);
      };
    });
  }
})();
</script>
</body>
</html>
