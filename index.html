<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Custom Metronome (Mobile)</title>
  <style>
    :root{
      --bg: #0b0b0f;
      --fg: #e8e8ee;
      --muted: #9aa0aa;
      --accent: #14b8a6; /* teal */
      --accent-2: #8b5cf6; /* violet */
      --danger: #ef4444; /* red */
      --btn-height: 18dvh; /* bottom bar height */
      --radius: 18px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      font-weight: 800; /* bold-looking */
      letter-spacing: 0.02em;
    }
    .app { height: 100dvh; display: flex; flex-direction: column; }

    .page { display: none; height: 100%; }
    .page.active { display: flex; flex-direction: column; min-height: 100%; }

    /* Shared bottom fixed button */
    .bottom {
      margin: 0; padding: 0; border: 0; outline: none;
      position: sticky; bottom: 0; left: 0; right: 0;
      height: var(--btn-height); width: 100%;
    }
    .bottom button {
      height: 100%; width: 100%; border: 0; margin: 0; padding: 0;
      border-radius: 0; cursor: pointer;
      background: var(--accent); color: #081012; /* high contrast */
      font-size: clamp(22px, 6.5vw, 42px);
      font-weight: 900;
    }
    .bottom button:disabled { background: #2a2f36; color: #6b7280; cursor: not-allowed; }

    /* Page 1 (Input) */
    .p1-main {
      flex: 1 1 auto;
      display: flex; align-items: center; justify-content: center;
      padding: 2.5vh 4vw; /* visual breathing room */
    }
    .form {
      width: 100%; max-width: 900px;
      display: flex; flex-direction: column; align-items: stretch; gap: 2.5vh;
    }
    .label { font-size: clamp(16px, 3.8vw, 22px); color: var(--muted); text-align: center; }
    .textbox {
      width: 100%;
      min-height: 24dvh; height: min(40dvh, 55%);
      background: #12141a; color: var(--fg);
      border: 2px solid #1f2430; border-radius: var(--radius);
      padding: 2.2vh 2.5vw;
      font-size: clamp(24px, 6.8vw, 44px);
      line-height: 1.25;
      resize: none;
    }
    .help { text-align: center; font-size: clamp(12px, 3.2vw, 16px); color: var(--muted); }

    /* Page 2 (Buttons) */
    .p2-main {
      flex: 1 1 auto;
      display: flex; flex-direction: column;
      /* Fill all space above the bottom bar with zero gaps */
    }
    .tempo-list { flex: 1 1 auto; display: flex; flex-direction: column; gap: 0; }
    .tempo-btn {
      position: relative;
      flex: 1 1 auto; width: 100%;
      display: flex; align-items: center; justify-content: center;
      margin: 0; padding: 0; border: 0; border-radius: 0;
      background: #141821; color: var(--fg);
      font-size: clamp(28px, 8vw, 60px);
      font-weight: 900;
      overflow: hidden;
      user-select: none;
    }
    .tempo-btn:nth-child(odd){ background: #10141c; }
    .tempo-btn:active { filter: brightness(1.25); }

    /* Flash indicator overlay inside each button */
    .flash-layer {
      position: absolute; inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.22), transparent 55%);
      opacity: 0; pointer-events: none;
      transition: opacity 120ms ease-out;
    }
    .flash-layer.show { opacity: 1; }

    /* Tiny live dot (top-right) shows whether that row is armed) */
    .live-dot {
      position: absolute; top: 10px; right: 12px; width: 14px; height: 14px;
      border-radius: 999px; background: #374151; box-shadow: 0 0 0 2px rgba(0,0,0,0.35) inset;
    }
    .tempo-btn.active .live-dot { background: var(--accent-2); }

    /* Back button styled like bottom GO */
    .back-btn { background: #334155; color: #e5e7eb; }

    /* Utility */
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="app" id="app">
  <!-- Page 1: Input -->
  <section class="page active" id="page1" aria-labelledby="page1-title">
    <main class="p1-main">
      <div class="form">
        <div class="label" id="page1-title">Enter comma-separated BPM</div>
        <textarea id="bpmInput" class="textbox" placeholder="e.g. 60, 120, 90"></textarea>
        <div class="help" id="validationMsg">&nbsp;</div>
      </div>
    </main>
    <div class="bottom">
      <button id="goBtn" disabled>GO</button>
    </div>
  </section>

  <!-- Page 2: Tempo buttons -->
  <section class="page" id="page2" aria-labelledby="page2-title">
    <main class="p2-main">
      <div class="tempo-list" id="tempoList" aria-live="polite" aria-label="Tempo buttons"></div>
    </main>
    <div class="bottom">
      <button id="backBtn" class="back-btn">BACK</button>
    </div>
  </section>
</div>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const page1 = $('#page1');
  const page2 = $('#page2');
  const bpmInput = $('#bpmInput');
  const validationMsg = $('#validationMsg');
  const goBtn = $('#goBtn');
  const backBtn = $('#backBtn');
  const tempoList = $('#tempoList');

  let wakeLock = null;
  async function requestWakeLock(){
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => { /* optional UI hook */ });
      }
    } catch (err) {
      // Likely unsupported or denied. Gracefully ignore.
    }
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && wakeLock === null) {
      requestWakeLock();
    }
  });
  requestWakeLock();

  // Parse & validate input
  function parseBPMs(text){
    const raw = text.split(',').map(s => s.trim()).filter(Boolean);
    if (raw.length === 0) return { ok:false, list:[], message: 'Enter at least one BPM.' };
    const nums = [];
    for (const r of raw){
      if (!/^\d+(?:\.\d+)?$/.test(r)) {
        return { ok:false, list:[], message: `Invalid number: "${r}"` };
      }
      const v = parseFloat(r);
      if (!isFinite(v) || v <= 0) {
        return { ok:false, list:[], message: `BPM must be > 0: "${r}"` };
      }
      nums.push(v);
    }
    return { ok:true, list:nums, message: `Looks good: ${nums.join(', ')}` };
  }

  function updateValidation(){
    const {ok, message} = parseBPMs(bpmInput.value);
    goBtn.disabled = !ok;
    validationMsg.textContent = message || '\u00A0';
    validationMsg.style.color = ok ? 'var(--muted)' : 'var(--danger)';
  }

  bpmInput.addEventListener('input', updateValidation);
  bpmInput.addEventListener('blur', updateValidation);
  updateValidation();

  // Navigation
  function showPage(which){
    for (const p of $$('.page')) p.classList.remove('active');
    (which === 1 ? page1 : page2).classList.add('active');
  }

  goBtn.addEventListener('click', () => {
    const {ok, list} = parseBPMs(bpmInput.value);
    if (!ok) return;
    buildTempoButtons(list);
    showPage(2);
  });

  backBtn.addEventListener('click', () => {
    stopAllFlashes();
    tempoList.innerHTML = '';
    showPage(1);
  });

  // Flash logic per button
  const timers = new Map(); // btn -> intervalId

  function stopFlash(btn){
    const id = timers.get(btn);
    if (id) { clearInterval(id); timers.delete(btn); }
    btn.classList.remove('active');
  }
  function stopAllFlashes(){
    timers.forEach(id => clearInterval(id));
    timers.clear();
    $$('.tempo-btn').forEach(b => b.classList.remove('active'));
  }

  function startFlash(btn, bpm){
    const ms = 60000 / bpm; // interval per beat
    const flash = btn.querySelector('.flash-layer');

    // Safety: stop any prior
    stopFlash(btn);

    const intervalId = setInterval(() => {
      flash.classList.add('show');
      // brief blink window (~120ms)
      setTimeout(() => flash.classList.remove('show'), 120);
    }, ms);
    timers.set(btn, intervalId);
    btn.classList.add('active');

    // Immediate first pulse so user sees it right away
    flash.classList.add('show');
    setTimeout(() => flash.classList.remove('show'), 140);
  }

  function toggleFlash(btn){
    if (timers.has(btn)) {
      stopFlash(btn);
    } else {
      const bpm = parseFloat(btn.dataset.bpm);
      startFlash(btn, bpm);
    }
  }

  function buildTempoButtons(list){
    tempoList.innerHTML = '';
    // Create one button per BPM, each filling equal vertical space with no margins/padding
    for (const bpm of list){
      const btn = document.createElement('button');
      btn.className = 'tempo-btn';
      btn.type = 'button';
      btn.dataset.bpm = String(bpm);
      btn.setAttribute('aria-pressed', 'false');
      btn.innerHTML = `
        <div class="flash-layer"></div>
        <div class="live-dot" aria-hidden="true"></div>
        <div class="label">${bpm} BPM</div>
      `;
      btn.addEventListener('click', () => {
        const active = timers.has(btn);
        toggleFlash(btn);
        btn.setAttribute('aria-pressed', String(!active));
      }, { passive: true });
      tempoList.appendChild(btn);
    }
  }

  // Optimize for mobile UX
  // Prevent iOS rubber-band scroll effects inside the app by keeping the layout simple.
  document.addEventListener('gesturestart', e => e.preventDefault());
})();
</script>
</body>
</html>
