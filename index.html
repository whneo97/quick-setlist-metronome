<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Custom Metronome (Mobile)</title>
  <style>
    :root{
      --bg: #0b0b0f;
      --fg: #e8e8ee;
      --muted: #9aa0aa;
      --accent: #14b8a6;
      --accent-2: #8b5cf6;
      --danger: #ef4444;
      --btn-height: 18dvh;
      --radius: 18px;
      --disabled-bg: #2a2f36;
      --disabled-color: #6b7280;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial;font-weight:800;letter-spacing:0.02em;}
    .app{height:100dvh;display:flex;flex-direction:column;}
    .page{display:none;height:100%}
    .page.active{display:flex;flex-direction:column;min-height:100%}
    .bottom{position:sticky;bottom:0;height:var(--btn-height);width:100%}
    .bottom button{height:100%;width:100%;border:0;margin:0;font-size:clamp(22px,6.5vw,42px);font-weight:900;transition:background 0.2s ease,color 0.2s ease;}
    #goBtn{background:var(--accent);color:#081012;}
    #goBtn:disabled{background:var(--disabled-bg);color:var(--disabled-color);cursor:not-allowed;}
    .back-btn{background:#1f2430;color:var(--fg);}
    .p1-main{flex:1;display:flex;align-items:center;justify-content:center;padding:2.5vh 4vw;}
    .form{width:100%;max-width:900px;display:flex;flex-direction:column;gap:2.2vh;}
    .label{text-align:center;font-size:clamp(16px,3.8vw,22px);color:var(--muted);}
    .textbox{width:100%;min-height:24dvh;background:#12141a;color:var(--fg);border:2px solid #1f2430;border-radius:var(--radius);padding:2.2vh;font-size:clamp(24px,6.8vw,44px);}    
    .error-msg{display:none;text-align:center;color:var(--danger);font-size:clamp(12px,3.2vw,16px);}    
    .preset-list{max-height:30vh;overflow-y:auto;background:#11151c;border-radius:var(--radius);padding:1vh;display:none;flex-direction:column;gap:1vh;}
    .preset-item{display:flex;align-items:center;justify-content:space-between;gap:1.2rem;background:#181c24;padding:1vh;border-radius:var(--radius);}
    .preset-info{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .preset-item.invalid .preset-info{color:var(--danger);}
    .preset-actions{display:flex;gap:4rem;flex-shrink:0;}
    .preset-item button{background:none;border:none;color:var(--accent);font-size:clamp(14px,3.5vw,20px);}    
    .preset-item.invalid button.load-btn{color:#555;pointer-events:none;}
    .tempo-list{flex:1;display:flex;flex-direction:column;}
    .tempo-btn{flex:1;width:100%;display:flex;align-items:center;justify-content:center;background:#141821;color:var(--fg);font-size:clamp(28px,8vw,60px);font-weight:900;position:relative;overflow:hidden;border:none;}
    .tempo-btn:nth-child(odd){background:#10141c;}
    .flash-layer{position:absolute;inset:0;background:radial-gradient(circle,rgba(255,255,255,0.22),transparent 55%);opacity:0;pointer-events:none;transition:opacity 120ms ease-out;}
    .flash-layer.show{opacity:1;}
    .live-dot{position:absolute;top:10px;right:12px;width:14px;height:14px;border-radius:999px;background:#374151;}
    .tempo-btn.active .live-dot{background:var(--accent-2);}    
  </style>
</head>
<body>
<div class="app" id="app">
  <section class="page active" id="page1">
    <main class="p1-main">
      <div class="form">
        <div class="label">Enter BPM values or choose a preset</div>
        <textarea id="bpmInput" class="textbox" placeholder="e.g. 60,120,90"></textarea>
        <div id="errorMsg" class="error-msg" role="alert" aria-live="polite"></div>
        <div class="preset-list" id="presetList"></div>
      </div>
    </main>
    <div class="bottom"><button id="goBtn" disabled>GO</button></div>
  </section>

  <section class="page" id="page2">
    <main class="tempo-list" id="tempoList"></main>
    <div class="bottom"><button id="backBtn" class="back-btn">BACK</button></div>
  </section>
</div>
<script>
(function(){
  const bpmInput=document.querySelector('#bpmInput');
  const goBtn=document.querySelector('#goBtn');
  const backBtn=document.querySelector('#backBtn');
  const tempoList=document.querySelector('#tempoList');
  const presetList=document.querySelector('#presetList');
  const errorMsg=document.querySelector('#errorMsg');

  let presets=JSON.parse(localStorage.getItem('bpmPresets')||'[]');

  function savePresets(){localStorage.setItem('bpmPresets',JSON.stringify(presets));renderPresets();}
  function renderPresets(){
    presetList.innerHTML='';
    if(presets.length===0){presetList.style.display='none';return;}
    presetList.style.display='flex';
    presets.forEach((p,i)=>{
      const {ok}=parseBPMs(p.value);
      const div=document.createElement('div');div.className='preset-item'+(ok?'':' invalid');
      const info=document.createElement('div');info.className='preset-info';info.textContent=`${p.name}: ${p.value}`;
      const actions=document.createElement('div');actions.className='preset-actions';
      const loadBtn=document.createElement('button');loadBtn.textContent='Load';loadBtn.className='load-btn';loadBtn.onclick=()=>{bpmInput.value=p.value;updateValidation();};
      const editBtn=document.createElement('button');editBtn.textContent='Edit';editBtn.onclick=()=>{const nv=prompt('Edit BPM list',p.value);if(nv!==null){p.value=nv;p.name=prompt('Preset name',p.name)||p.name;savePresets();}};
      const delBtn=document.createElement('button');delBtn.textContent='Del';delBtn.onclick=()=>{if(confirm('Delete this preset?')){presets.splice(i,1);savePresets();}};
      if(!ok)loadBtn.disabled=true;
      actions.append(loadBtn,editBtn,delBtn);
      div.append(info,actions);
      presetList.appendChild(div);
    });
  }

  function parseBPMs(txt){
    const raw=txt.split(',').map(s=>s.trim()).filter(Boolean);
    if(!raw.length)return{ok:false,list:[],message:''};
    const nums=[];
    for(const r of raw){
      if(!/^\d+(?:\.\d+)?$/.test(r))return{ok:false,list:[],message:`Invalid number: "${r}"`};
      const v=parseFloat(r);
      if(!(v>0))return{ok:false,list:[],message:`BPM must be > 0: "${r}"`};
      nums.push(v);
    }
    return{ok:true,list:nums,message:''};
  }

  function inputsEqual(a,b){
    const normA=a.split(',').map(s=>s.trim()).filter(Boolean);
    const normB=b.split(',').map(s=>s.trim()).filter(Boolean);
    if(normA.length!==normB.length)return false;
    return normA.every((v,i)=>v===normB[i]);
  }

  function updateValidation(){
    const {ok,message}=parseBPMs(bpmInput.value);
    goBtn.disabled=!ok;
    if(ok||bpmInput.value.trim()===''){errorMsg.textContent='';errorMsg.style.display='none';}
    else{errorMsg.textContent=message;errorMsg.style.display='block';}
  }
  bpmInput.addEventListener('input',updateValidation);
  updateValidation();
  renderPresets();

  goBtn.onclick=()=>{
    const {ok,list}=parseBPMs(bpmInput.value);
    if(!ok){updateValidation();return;}
    const duplicateExists=presets.some(p=>inputsEqual(p.value,bpmInput.value));
    let name=null;
    if(!duplicateExists){
      name=prompt('Preset name?','My preset');
      if(name){
        presets.push({name,value:bpmInput.value});
        savePresets();
      }
    }
    buildTempoButtons(list);showPage(2);
  };
  backBtn.onclick=()=>{stopAllFlashes();tempoList.innerHTML='';showPage(1);};

  function showPage(n){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelector(n===1?'#page1':'#page2').classList.add('active');}
  const timers=new Map();
  function stopFlash(b){const id=timers.get(b);if(id){clearInterval(id);timers.delete(b);}b.classList.remove('active');}
  function stopAllFlashes(){timers.forEach(clearInterval);timers.clear();document.querySelectorAll('.tempo-btn').forEach(b=>b.classList.remove('active'))}
  function startFlash(b,bpm){const ms=60000/bpm;const f=b.querySelector('.flash-layer');stopFlash(b);const id=setInterval(()=>{f.classList.add('show');setTimeout(()=>f.classList.remove('show'),120);},ms);timers.set(b,id);b.classList.add('active');f.classList.add('show');setTimeout(()=>f.classList.remove('show'),140);}  
  function toggleFlash(b){timers.has(b)?stopFlash(b):startFlash(b,parseFloat(b.dataset.bpm));}
  function buildTempoButtons(list){tempoList.innerHTML='';list.forEach(bpm=>{const b=document.createElement('button');b.className='tempo-btn';b.dataset.bpm=bpm;b.innerHTML=`<div class="flash-layer"></div><div class="live-dot"></div><div>${bpm} BPM</div>`;b.onclick=()=>toggleFlash(b);tempoList.appendChild(b);});}

  if('wakeLock' in navigator){navigator.wakeLock.request('screen').catch(()=>{});}  
})();
</script>
</body>
</html>
